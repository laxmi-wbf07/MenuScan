<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="description" content="Druk Appetite ‚Äî Taste the Thunder. Premium Bhutanese cuisine with authentic Himalayan flavors.">
<meta name="theme-color" content="#D4841D">
<title>Druk Appetite ‚Äî Taste the Thunder</title>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{--saffron:#D4841D;--red:#EC1C24;--cream:#F5F1E8;--indigo:#1A237E;--dark:#0D0D0D;--gold:#FFD700;--shadow:rgba(0,0,0,0.6)}
html{font-size:16px;scroll-behavior:smooth}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--dark);color:var(--cream);overflow:hidden;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}

/* Header */
#header{position:fixed;top:0;left:0;right:0;z-index:1000;padding:1.25rem 2rem;background:linear-gradient(180deg,rgba(13,13,13,0.95) 0%,rgba(13,13,13,0) 100%);display:flex;justify-content:space-between;align-items:center;pointer-events:none}
#header>*{pointer-events:auto}
.brand{display:flex;flex-direction:column;gap:.25rem}
.brand h1{font-family:'Georgia','Times New Roman',serif;font-size:1.75rem;font-weight:400;letter-spacing:.05em;color:var(--cream);text-shadow:0 2px 20px var(--shadow)}
.brand .tagline{font-size:.75rem;color:var(--saffron);letter-spacing:.3em;text-transform:uppercase}
#fav-counter{display:flex;align-items:center;gap:.5rem;padding:.75rem 1.25rem;background:rgba(212,132,29,0.15);border:1px solid var(--saffron);border-radius:50px;font-size:1rem;color:var(--saffron);backdrop-filter:blur(10px)}
#fav-counter .star{font-size:1.25rem;animation:pulse 2s ease-in-out infinite}
#fav-count{font-weight:700;font-size:1.1rem}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}

/* Container */
#container{display:flex;height:100vh;width:100vw;overflow-x:scroll;overflow-y:hidden;scroll-snap-type:x mandatory;scroll-behavior:smooth;-webkit-overflow-scrolling:touch;scrollbar-width:none}
#container::-webkit-scrollbar{display:none}

/* Card */
.card{min-width:100vw;width:100vw;height:100vh;scroll-snap-align:center;position:relative;perspective:2000px;cursor:pointer;touch-action:manipulation}
.card-inner{width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform .65s cubic-bezier(.4,0,.2,1)}
.card.flipped .card-inner{transform:rotateY(180deg)}
.card-face{position:absolute;width:100%;height:100%;backface-visibility:hidden;display:flex;flex-direction:column;overflow:hidden}

/* Front */
.card-front{background:var(--dark)}
.img-wrapper{width:100%;height:100%;position:relative;overflow:hidden}
.dish-img{width:100%;height:100%;object-fit:cover;object-position:center 30%;filter:brightness(.85);transition:transform 12s ease-out,filter .5s ease}
.card.snapped .dish-img{transform:scale(1.08);filter:brightness(1)}
.vignette{position:absolute;inset:0;background:radial-gradient(ellipse at center,transparent 30%,rgba(0,0,0,.4) 70%,rgba(0,0,0,.8) 100%);pointer-events:none}

/* Front overlays */
.dish-name-front{position:absolute;bottom:5rem;left:50%;transform:translateX(-50%);font-family:'Georgia','Times New Roman',serif;font-size:clamp(1.5rem,4vw,2.5rem);font-weight:400;color:var(--cream);text-align:center;padding:1rem 2rem;background:linear-gradient(135deg,rgba(13,13,13,0.7) 0%,rgba(13,13,13,0.3) 100%);border-radius:8px;backdrop-filter:blur(10px);text-shadow:0 4px 30px var(--shadow);max-width:90%;line-height:1.3}
.dish-price-front{position:absolute;bottom:1.5rem;right:2rem;font-family:'Georgia','Times New Roman',serif;font-size:clamp(1.5rem,3vw,2rem);font-weight:700;color:var(--saffron);padding:.75rem 1.5rem;background:rgba(13,13,13,0.8);border-left:3px solid var(--saffron);border-radius:4px;text-shadow:0 2px 15px rgba(212,132,29,0.4)}
.fav-badge-front{position:absolute;top:8rem;left:2rem;width:3.5rem;height:3.5rem;display:flex;align-items:center;justify-content:center;font-size:1.5rem;background:rgba(212,132,29,0.2);border:1px solid var(--saffron);border-radius:50%;backdrop-filter:blur(10px);transition:transform .2s ease}
.fav-badge-front.pop{animation:pop .3s ease}

/* Back */
.card-back{background:linear-gradient(135deg,var(--dark) 0%,var(--cream) 100%);transform:rotateY(180deg);padding:4rem 2rem 3rem;justify-content:flex-start;align-items:center;overflow-y:auto}
.back-inner{width:100%;max-width:600px;text-align:center}
.accent-border{position:absolute;top:0;left:0;bottom:0;width:6px;background:var(--saffron);border-radius:3px 0 0 3px}
.dish-name-back{font-family:'Georgia','Times New Roman',serif;font-size:clamp(1.5rem,3.5vw,2.25rem);font-weight:400;color:var(--indigo);margin-bottom:.5rem;line-height:1.2}
.price-back{font-size:clamp(1.25rem,2.5vw,1.75rem);font-weight:700;color:var(--saffron);margin-bottom:1.25rem;padding:.5rem 0;border-bottom:1px solid rgba(212,132,29,0.3);display:inline-block}
.description{font-size:1rem;line-height:1.7;color:#333;margin-bottom:1rem;padding:0 .5rem}
.tags{font-size:1.75rem;margin:.75rem 0;letter-spacing:.25rem}
.calorie-wrapper{display:flex;align-items:center;gap:.75rem;margin:1rem 0;padding:.5rem 1rem;background:rgba(255,255,255,.5);border-radius:8px}
.calorie-label{font-size:.75rem;color:#666;text-transform:uppercase;letter-spacing:.1em}
.calorie-bar{flex:1;height:6px;background:rgba(0,0,0,.1);border-radius:3px;overflow:hidden}
.calorie-fill{height:100%;border-radius:3px;transition:width .5s ease}
.chef-hack{margin-top:1.5rem;padding:1rem 1.25rem;background:linear-gradient(135deg,rgba(212,132,29,0.1) 0%,rgba(212,132,29,0.05) 100%);border-left:3px solid var(--saffron);border-radius:0 8px 8px 0;text-align:left;opacity:0;transform:translateY(10px);animation:revealChef .6s .3s forwards}
@keyframes revealChef{to{opacity:1;transform:translateY(0)}}
.chef-hack .label{font-size:.65rem;text-transform:uppercase;letter-spacing:.2em;color:var(--saffron);margin-bottom:.5rem}
.chef-hack .text{font-family:'Georgia','Times New Roman',serif;font-style:italic;font-size:.95rem;color:var(--indigo);line-height:1.5}
.chef-hack .emoji{font-size:1.25rem;margin-left:.5rem}

@keyframes pop{0%{transform:scale(1)}50%{transform:scale(1.3)}100%{transform:scale(1)}}

/* Placeholder */
.placeholder{width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1rem;color:var(--cream);opacity:.7}
.placeholder .spinner{width:40px;height:40px;border:3px solid rgba(212,132,29,0.3);border-top-color:var(--saffron);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Scroll hint */
.scroll-hint{position:absolute;bottom:1rem;left:50%;transform:translateX(-50%);font-size:.75rem;color:rgba(255,255,255,.5);letter-spacing:.2em;text-transform:uppercase;animation:bounce 2s ease-in-out infinite}
@keyframes bounce{0%,100%{transform:translateX(-50%) translateY(0)}50%{transform:translateX(-50%) translateY(-5px)}}

/* Reduced motion */
@media(prefers-reduced-motion:reduce){
*,*::before,*::after{animation:none!important;transition:none!important}
.dish-img{transition:none!important}
.card.snapped .dish-img{transform:scale(1.08)}
.card-inner{transition:transform .3s ease}
}

/* Mobile */
@media(max-width:600px){
#header{padding:1rem}
.brand h1{font-size:1.35rem}
.brand .tagline{font-size:.65rem;letter-spacing:.2em}
#fav-counter{padding:.6rem 1rem;font-size:.9rem}
.card-back{padding:3rem 1.5rem 2rem}
.dish-price-front{right:1.5rem;bottom:1rem;font-size:1.5rem}
.fav-badge-front{top:7rem;left:1.5rem;width:3rem;height:3rem;font-size:1.25rem}
}
</style>
</head>
<body>
<header id="header" role="banner">
<div class="brand">
<h1>Druk Appetite</h1>
<span class="tagline">Taste the Thunder</span>
</div>
<div id="fav-counter" role="status" aria-live="polite">
<span class="star">‚≠ê</span>
<span><span id="fav-count">0</span></span>
</div>
</header>
<main id="container" role="main" aria-label="Menu dishes">
<div class="placeholder">
<div class="spinner"></div>
<span>Loading Druk Appetite...</span>
</div>
</main>
<div class="scroll-hint" aria-hidden="true">‚Üê Swipe ‚Üí</div>
<script>
(function(){
'use strict';

const APP={
db:null,
dishes:[],
menuUrl:'menu.md',
lastEtag:null,
chefSecrets:null
};

// Extract emoji from text
function extractEmojis(text){
const emojiPattern=/[\u{1F300}-\u{1F9FF}]/gu;
const emojis=emojiPattern.exec(text);
return emojis?emojis.join(' '):'';
}

// Parse markdown menu
function parseMenuMd(text){
const lines=text.split('\n').filter(l=>l.trim()&&l.startsWith('##'));
return lines.map((line,idx)=>{
const parts=line.substring(2).split('|').map(p=>p.trim());
if(parts.length<4)return null;
const name=parts[0];
const price=parts[1];
const desc=parts[2];
return{
id:idx+1,
name,
price,
description:desc,
emoji:extractEmojis(desc),
imageUrl:parts[3],
favorites:0,
color:null,
calorieValue:450+Math.floor(Math.random()*300)
};
}).filter(Boolean);
}

// Fetch menu from server
async function fetchMenu(){
try{
const resp=await fetch(APP.menuUrl,{cache:'no-cache'});
if(!resp.ok)throw new Error('Failed to fetch');
const text=await resp.text();
const etag=resp.headers.get('etag')||resp.headers.get('content-length')||'';
return{text,etag};
}catch(e){
console.log('[Menu] Fetch failed:',e.message);
return null;
}
}

// IndexedDB operations
async function initDB(){
return new Promise((resolve,reject)=>{
const req=indexedDB.open('MenuDB',1);
req.onerror=()=>reject(req.error);
req.onsuccess=()=>{APP.db=req.result;resolve()};
req.onupgradeneeded=e=>{
const db=e.target.result;
if(!db.objectStoreNames.contains('dishes')){
db.createObjectStore('dishes',{keyPath:'id'});
}
if(!db.objectStoreNames.contains('meta')){
db.createObjectStore('meta',{keyPath:'key'});
}
};
});
}

async function storeDishes(dishes){
const tx=APP.db.transaction(['dishes'],'readwrite');
const store=tx.objectStore('dishes');
dishes.forEach(d=>store.put(d));
return new Promise((resolve,reject)=>{
tx.oncomplete=()=>resolve();
tx.onerror=()=>reject(tx.error);
});
}

async function loadDishesFromDB(){
return new Promise((resolve,reject)=>{
const tx=APP.db.transaction(['dishes'],'readonly');
const store=tx.objectStore('dishes');
const req=store.getAll();
req.onsuccess=()=>resolve(req.result||[]);
req.onerror=()=>reject(req.error);
});
}

async function getMeta(key){
return new Promise(resolve=>{
const tx=APP.db.transaction(['meta'],'readonly');
const req=tx.objectStore('meta').get(key);
req.onsuccess=()=>resolve(req.result?.value);
req.onerror=()=>resolve(null);
});
}

async function setMeta(key,value){
return new Promise(resolve=>{
const tx=APP.db.transaction(['meta'],'readwrite');
tx.objectStore('meta').put({key,value});
tx.oncomplete=()=>resolve();
tx.onerror=()=>resolve();
});
}

async function updateDish(dish){
return new Promise((resolve,reject)=>{
const tx=APP.db.transaction(['dishes'],'readwrite');
const req=tx.objectStore('dishes').put(dish);
req.onsuccess=()=>resolve();
req.onerror=()=>reject(req.error);
});
}

// Extract dominant color from image
function extractPalette(img){
const canvas=document.createElement('canvas');
const ctx=canvas.getContext('2d');
const w=img.naturalWidth||img.width||200;
const h=img.naturalHeight||img.height||200;
canvas.width=w;
canvas.height=h;
ctx.drawImage(img,0,0,w,h);

const samples=[
[w*0.1,h*0.1],[w*0.9,h*0.1],[w*0.5,h*0.5],[w*0.1,h*0.9],[w*0.9,h*0.9],[w*0.3,h*0.3],[w*0.7,h*0.3],[w*0.3,h*0.7]
];

let r=0,g=0,b=0,count=0;
samples.forEach(([x,y])=>{
try{
const data=ctx.getImageData(Math.floor(x),Math.floor(y),1,1).data;
if(data[3]>128){
r+=data[0];g+=data[1];b+=data[2];count++;
}
}catch(e){}
});

if(count===0)return'#D4841D';
r=Math.floor(r/count);g=Math.floor(g/count);b=Math.floor(b/count);

const brightness=(r*299+g*587+b*114)/1000;
if(brightness>200){r=Math.floor(r*.7);g=Math.floor(g*.7);b=Math.floor(b*.7);}
if(brightness>240){r=Math.floor(r*.8);g=Math.floor(g*.8);b=Math.floor(b*.8);}

const hex=r.toString(16).padStart(2,'0')+g.toString(16).padStart(2,'0')+b.toString(16).padStart(2,'0');
return`#${hex}`;
}

// Get chef secret based on dish
function getChefSecret(dish){
const secrets={
'Thunder\'s First Breath (Spiced Starter)':'Served with our house-made achar sauce‚Äîfermented for 7 days with Sichuan peppercorns üå∂Ô∏è',
'Golden Silk of the Phobjikha Valley':'Finish with a drizzle of melted butter and fresh thyme from our mountain garden üßÄ',
'Heart of the Dragon (Phaksha Paa)':'Best enjoyed with steamed red rice and a cold butter tea at sunset üåÖ',
'Sacred Flame (Ema Datshi Supreme)':'The chilies are flame-roasted daily‚Äîtrust the heat, it\'s part of the experience üî•',
'Sherpa\'s Summit (Himalayan Chicken)':'Marinated overnight in ginger, garlic, and mountain honey forÊ∑±Â∫¶ flavor üêî',
'River Stone Harvest (Seasonal Vegetables)':'Each vegetable is hand-selected from our partner farms in Bumthang ü•¨'
};
return secrets[dish.name]||'Chef recommends pairing with our house-made ginger tea üçµ';
}

// Render all dishes
function renderDishes(dishes){
const container=document.getElementById('container');
container.innerHTML='';
APP.dishes=dishes;
updateFavCounter();

if(dishes.length===0){
container.innerHTML='<div class="placeholder"><span>Druk Appetite is preparing...</span></div>';
return;
}

dishes.forEach((dish,idx)=>{
const card=document.createElement('div');
card.className='card';
card.dataset.id=dish.id;
card.setAttribute('role','article');
card.setAttribute('aria-label',`${dish.name}, ${dish.price}`);

const inner=document.createElement('div');
inner.className='card-inner';

const front=document.createElement('div');
front.className='card-face card-front';

const imgWrapper=document.createElement('div');
imgWrapper.className='img-wrapper';

const img=document.createElement('img');
img.className='dish-img';
img.alt=dish.name;
img.loading=idx<2?'eager':'lazy';
img.dataset.src=dish.imageUrl;

const vignette=document.createElement('div');
vignette.className='vignette';

const dishName=document.createElement('div');
dishName.className='dish-name-front';
dishName.textContent=dish.name;

const dishPrice=document.createElement('div');
dishPrice.className='dish-price-front';
dishPrice.textContent=dish.price;

const favBadge=document.createElement('div');
favBadge.className='fav-badge-front';
favBadge.innerHTML='‚≠ê';
if(dish.favorites>0){
favBadge.textContent=`‚≠ê${dish.favorites}`;
favBadge.style.opacity='1';
}else{
favBadge.style.opacity='0';
}

imgWrapper.append(img,vignette);
front.append(imgWrapper,dishName,dishPrice,favBadge);

const back=document.createElement('div');
back.className='card-face card-back';

const backInner=document.createElement('div');
backInner.className='back-inner';

const accentBorder=document.createElement('div');
accentBorder.className='accent-border';

const dishNameBack=document.createElement('h2');
dishNameBack.className='dish-name-back';
dishNameBack.textContent=dish.name;

const priceBack=document.createElement('div');
priceBack.className='price-back';
priceBack.textContent=dish.price;

const description=document.createElement('p');
description.className='description';
description.textContent=dish.description;

const tags=document.createElement('div');
tags.className='tags';
tags.textContent=dish.emoji||'üçΩÔ∏è';

const calorieWrapper=document.createElement('div');
calorieWrapper.className='calorie-wrapper';

const calorieLabel=document.createElement('span');
calorieLabel.className='calorie-label';
calorieLabel.textContent='Calorie';

const calorieBar=document.createElement('div');
calorieBar.className='calorie-bar';

const calorieFill=document.createElement('div');
calorieFill.className='calorie-fill';
calorieFill.style.width=`${Math.min(100,(dish.calorieValue/900)*100)}%`;

calorieBar.appendChild(calorieFill);
calorieWrapper.append(calorieLabel,calorieBar);

const chefHack=document.createElement('div');
chefHack.className='chef-hack';
chefHack.innerHTML=`
<div class="label">Chef's Secret</div>
<div class="text">${getChefSecret(dish)}</div>
`;
if(dish.favorites<5){
chefHack.style.display='none';
}

backInner.append(accentBorder,dishNameBack,priceBack,description,tags,calorieWrapper,chefHack);
back.appendChild(backInner);

inner.append(front,back);
card.append(inner);
container.appendChild(card);

img.addEventListener('load',()=>{
if(!dish.color){
const color=extractPalette(img);
dish.color=color;
accentBorder.style.background=color;
priceBack.style.color=color;
calorieFill.style.background=color;
updateDish(dish);
}
});
img.src=img.dataset.src;
});

setupInteractions();
setupScrollSnap();
}

// Update favorite counter
function updateFavCounter(){
const total=APP.dishes.reduce((sum,d)=>sum+d.favorites,0);
document.getElementById('fav-count').textContent=total;
}

// Setup card interactions
function setupInteractions(){
const cards=document.querySelectorAll('.card');

const tapHandler=createTapHandler();
cards.forEach(card=>{
card.addEventListener('click',e=>{
e.preventDefault();
tapHandler(card);
},{passive:false});

card.addEventListener('keydown',e=>{
if(e.key==='Enter'||e.key===' '){
e.preventDefault();
card.classList.toggle('flipped');
}else if(e.key==='f'||e.key==='F'){
e.preventDefault();
handleFavorite(card);
}
});
card.setAttribute('tabindex','0');
card.setAttribute('role','button');
});
}

// Create tap handler with double-tap detection
function createTapHandler(){
let lastTap=0;
let tapTarget=null;
return function(card){
const now=Date.now();
const timeSince=now-lastTap;
if(timeSince<250&&tapTarget===card){
handleFavorite(card);
lastTap=0;
tapTarget=null;
}else{
card.classList.toggle('flipped');
lastTap=now;
tapTarget=card;
}
};
}

// Handle favorite action
async function handleFavorite(card){
const id=parseInt(card.dataset.id);
const dish=APP.dishes.find(d=>d.id===id);
if(!dish)return;

dish.favorites++;
await updateDish(dish);
updateFavCounter();

const favBadge=card.querySelector('.fav-badge-front');
favBadge.textContent=`‚≠ê${dish.favorites}`;
favBadge.classList.remove('pop');
void favBadge.offsetWidth;
favBadge.classList.add('pop');

const chefHack=card.querySelector('.chef-hack');
if(dish.favorites===5){
chefHack.style.display='block';
}

const wasFlipped=card.classList.contains('flipped');
if(wasFlipped)card.classList.remove('flipped');
setTimeout(()=>{
renderDishes(APP.dishes);
if(wasFlipped){
const newCard=document.querySelector(`[data-id="${id}"]`);
if(newCard)newCard.classList.add('flipped');
}
},100);
}

// Setup scroll snap and snap detection
function setupScrollSnap(){
const container=document.getElementById('container');
const cards=document.querySelectorAll('.card');

const snapObserver=new IntersectionObserver(entries=>{
entries.forEach(entry=>{
if(entry.isIntersecting){
entry.target.classList.add('snapped');
entry.target.setAttribute('aria-current','true');
}else{
entry.target.classList.remove('snapped');
entry.target.removeAttribute('aria-current');
}
});
},{threshold:.5});
cards.forEach(card=>snapObserver.observe(card));

container.addEventListener('scroll',()=>{
cards.forEach(card=>{
const rect=card.getBoundingClientRect();
const centerX=window.innerWidth/2;
const cardCenterX=rect.left+rect.width/2;
const dist=Math.abs(centerX-cardCenterX);
if(dist<rect.width/4){
card.classList.add('snapped');
}else{
card.classList.remove('snapped');
}
});
},{passive:true});

document.addEventListener('keydown',e=>{
if(e.key==='ArrowRight'||e.key==='PageDown'){
e.preventDefault();
container.scrollBy({left:window.innerWidth,behavior:'smooth'});
}else if(e.key==='ArrowLeft'||e.key==='PageUp'){
e.preventDefault();
container.scrollBy({left:-window.innerWidth,behavior:'smooth'});
}else if(e.key==='Home'){
e.preventDefault();
container.scrollTo({left:0,behavior:'smooth'});
}else if(e.key==='End'){
e.preventDefault();
container.scrollTo({left:container.scrollWidth,behavior:'smooth'});
}
});
}

// Sync menu if changed
async function syncMenuIfChanged(){
const data=await fetchMenu();
if(!data)return;

const lastEtag=await getMeta('etag');
if(data.etag&&lastEtag&&data.etag===lastEtag){
console.log('[Menu] Menu unchanged');
return;
}

const dishes=parseMenuMd(data.text);
if(dishes.length===0)return;

const existing=await loadDishesFromDB();
const favMap=new Map(existing.map(d=>[d.name,{favorites:d.favorites,color:d.color}]));
const colorMap=new Map(existing.map(d=>[d.name,d.color]));

dishes.forEach(d=>{
const prev=favMap.get(d.name);
if(prev){
d.favorites=prev.favorites;
d.color=prev.color;
}else if(colorMap.has(d.name)){
d.color=colorMap.get(d.name);
}
});

await storeDishes(dishes);
await setMeta('etag',data.etag);
console.log('[Menu] Menu updated');
renderDishes(dishes);
}

// Initialize app
async function init(){
try{
await initDB();
console.log('[Menu] IndexedDB ready');

const cached=await loadDishesFromDB();
if(cached.length>0){
console.log(`[Menu] Loaded ${cached.length} dishes from cache`);
renderDishes(cached);
syncMenuIfChanged();
}else{
const data=await fetchMenu();
if(!data){
renderDishes([]);
return;
}
const dishes=parseMenuMd(data.text);
if(dishes.length>0){
await storeDishes(dishes);
await setMeta('etag',data.etag);
renderDishes(dishes);
}
}
}catch(e){
console.log('[Menu] Error:',e.message);
document.getElementById('container').innerHTML='<div class="placeholder"><span>Unable to load menu</span></div>';
}
}

if(document.readyState==='loading'){
document.addEventListener('DOMContentLoaded',init);
}else{
init();
}
})();
</script>
</body>
</html>
